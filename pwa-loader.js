const SW_PATH="/hocg-deck-convert/sw.js";const CARDS_DB_URL="https://qrimpuff.github.io/hocg-fan-sim-assets/hocg_cards.json";const IMAGE_BASE_JP="https://qrimpuff.github.io/hocg-fan-sim-assets/img/";const IMAGE_BASE_EN="https://qrimpuff.github.io/hocg-fan-sim-assets/img_en/";if("serviceWorker"in navigator){const initServiceWorker=()=>{const sendOfflineHint=()=>{const payload={type:"OFFLINE_HINT",offline:!navigator.onLine};if(navigator.serviceWorker.controller){navigator.serviceWorker.controller.postMessage(payload);return;}navigator.serviceWorker.ready.then(registration=>{if(registration.active){registration.active.postMessage(payload);}}).catch(()=>{});};navigator.serviceWorker.addEventListener("message",event=>{if(event.data&&event.data.type==="PREFETCH_PROGRESS"){updateProgressUI(event.data.loaded,event.data.total,event.data.size);}});navigator.serviceWorker.register(SW_PATH).then(registration=>{console.log("ServiceWorker registration successful with scope: ",registration.scope);sendOfflineHint();window.addEventListener("online",sendOfflineHint);window.addEventListener("offline",sendOfflineHint);const isStandalone=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||document.referrer.includes("android-app://");if(isStandalone){console.log("PWA is installed/standalone. Initiating card prefetch...");prefetchCards(registration);}}).catch(err=>{console.log("ServiceWorker registration failed: ",err);});};if(document.readyState==="complete"||document.readyState==="interactive"){initServiceWorker();}else{window.addEventListener("DOMContentLoaded",initServiceWorker);}}function prefetchCards(registration){fetch(CARDS_DB_URL).then(res=>res.json()).then(async data=>{try{await registration.update();}catch(e){console.log("SW update check failed (offline?):",e);}const urls=new Set;Object.values(data).forEach(card=>{if(!card.illustrations)return;card.illustrations.forEach(ill=>{if(!ill.img_path||typeof ill.img_path!=="object")return;if(ill.img_path.jp)urls.add(IMAGE_BASE_JP+ill.img_path.jp);if(ill.img_path.en)urls.add(IMAGE_BASE_EN+ill.img_path.en);});});const urlList=Array.from(urls);if(urlList.length===0)return;const serviceWorker=registration.installing||registration.waiting||registration.active;if(!serviceWorker)return;const sendPrefetch=()=>{serviceWorker.postMessage({type:"PREFETCH_CARDS",urls:urlList});};if(serviceWorker.state==="activated"){sendPrefetch();}else{serviceWorker.addEventListener("statechange",e=>{if(e.target.state==="activated"){sendPrefetch();}});}}).catch(console.error);}function formatBytes(bytes){if(bytes===0)return"0 B";const sizes=["B","KB","MB","GB"];const i=Math.floor(Math.log(bytes)/Math.log(1024));return(bytes/Math.pow(1024,i)).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})+" "+sizes[i];}function updateProgressUI(loaded,total,size=0){let container=document.getElementById("pwa-prefetch-progress");const hasDownloadedData=size>0;if(loaded>=total){if(container&&container.style.opacity!=="0"){const title=container.querySelector("#pwa-progress-title");if(title)title.textContent="Offline download complete!";const mainBar=container.querySelector("#pwa-progress-main-bar");if(mainBar){mainBar.classList.replace("is-info","is-success");mainBar.value=total;}const compactBar=container.querySelector("#pwa-progress-compact-bar");if(compactBar){compactBar.classList.replace("is-info","is-success");compactBar.value=total;compactBar.max=total;}const text=container.querySelector("#pwa-progress-text");if(text)text.textContent=`${loaded} / ${total}`;container.style.transition="opacity 0.5s ease";setTimeout(()=>{container.style.opacity="0";setTimeout(()=>container.remove(),600);},1500);}else if(container){container.remove();}return;}if(!container&&!hasDownloadedData){return;}if(!container){createProgressContainer(loaded,total,size);return;}const mainBar=container.querySelector("#pwa-progress-main-bar");const compactBar=container.querySelector("#pwa-progress-compact-bar");const text=container.querySelector("#pwa-progress-text");const sizeText=container.querySelector("#pwa-progress-size");if(mainBar){mainBar.value=loaded;mainBar.max=total;}if(compactBar){compactBar.value=loaded;compactBar.max=total;}if(text){text.textContent=`${loaded} / ${total}`;}if(sizeText){sizeText.textContent=formatBytes(size);}}function applyProgressLayout(container,collapsed){const expanded=container.querySelector("#pwa-progress-expanded");const compact=container.querySelector("#pwa-progress-compact");const compactBar=container.querySelector("#pwa-progress-compact-bar");if(expanded)expanded.style.display=collapsed?"none":"";if(compact)compact.style.display=collapsed?"flex":"none";container.style.width=collapsed?"220px":"320px";container.style.padding=collapsed?"0.5rem 0.625rem":"";if(compactBar)compactBar.style.height=collapsed?"0.65rem":"";}function createProgressContainer(loaded,total,size=0){let container=document.getElementById("pwa-prefetch-progress");if(container)return;container=document.createElement("div");container.id="pwa-prefetch-progress";container.className="notification";container.style.cssText="position: fixed; bottom: 20px; right: 20px; width: 320px; z-index: 9999; box-shadow: 0 0.5em 1em -0.125em rgba(10,10,10,.1), 0 0px 0 1px rgba(10,10,10,.02); opacity: 0; transform: translateY(8px); transition: opacity 0.3s ease, transform 0.3s ease;";container.innerHTML=`
        <div id="pwa-progress-expanded">
            <div class="is-flex is-justify-content-space-between is-align-items-center mb-2">
                <p id="pwa-progress-title" class="subtitle is-6 mb-0 has-text-weight-bold">Downloading cards for offline</p>
                <a id="pwa-progress-collapse" class="tag" href="#" aria-label="Hide details" title="Hide details" style="cursor: pointer; text-decoration: none;">
                    <span class="icon is-small"><i class="fa-solid fa-chevron-down"></i></span>
                </a>
            </div>
            <progress id="pwa-progress-main-bar" class="progress is-info is-small mb-2" value="${loaded}" max="${total}"></progress>
            <div class="is-flex is-justify-content-space-between is-size-7 has-text-grey">
                <span id="pwa-progress-text">${loaded} / ${total}</span>
                <span id="pwa-progress-size">${formatBytes(size)}</span>
            </div>
        </div>
        <div id="pwa-progress-compact" class="is-align-items-center" style="display:none; gap: 0.35rem;">
            <span class="icon is-small has-text-grey" aria-hidden="true" style="width: 1rem; height: 1rem;"><i class="fa-solid fa-download"></i></span>
            <progress id="pwa-progress-compact-bar" class="progress is-info is-small mb-0" value="${loaded}" max="${total}" style="flex: 1; margin-bottom: 0; height: 0.65rem;"></progress>
            <a id="pwa-progress-expand" class="tag" href="#" aria-label="Show details" title="Show details" style="cursor: pointer; text-decoration: none;">
                <span class="icon is-small"><i class="fa-solid fa-chevron-up"></i></span>
            </a>
        </div>
    `;document.body.appendChild(container);requestAnimationFrame(()=>{container.style.opacity="1";container.style.transform="translateY(0)";});const collapse=container.querySelector("#pwa-progress-collapse");if(collapse){collapse.addEventListener("click",event=>{event.preventDefault();applyProgressLayout(container,true);});}const expand=container.querySelector("#pwa-progress-expand");if(expand){expand.addEventListener("click",event=>{event.preventDefault();applyProgressLayout(container,false);});}}